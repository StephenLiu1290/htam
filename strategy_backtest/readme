core calculation for strategy backtest, it depends on helper functions.
